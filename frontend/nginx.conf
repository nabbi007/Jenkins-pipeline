server {
  listen 80;
  server_name _;

  add_header X-Content-Type-Options nosniff;
  add_header X-Frame-Options DENY;
  add_header Referrer-Policy strict-origin-when-cross-origin;

  root /usr/share/nginx/html;
  index index.html;

  location / {
    try_files $uri $uri/ /index.html;
  }

  location /api/ {
    proxy_pass http://backend:3000/api/;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;

    # Fail fast if backend is unreachable.
    proxy_connect_timeout 5s;
    proxy_read_timeout    10s;
    proxy_send_timeout    10s;

    # Return JSON error when backend is down instead of nginx default HTML page.
    proxy_intercept_errors on;
    error_page 502 503 504 = @backend_down;
  }

  # Nginx-only liveness probe — returns 200 immediately without touching backend.
  # Use this to check that the nginx process itself is alive.
  location = /nginx-health {
    access_log off;
    return 200 '{"status":"ok","service":"nginx"}';
    default_type application/json;
  }

  # Health probe used by the Docker HEALTHCHECK — tests the backend path end-to-end.
  location = /health {
    proxy_pass http://backend:3000/api/health;
    proxy_http_version 1.1;
    proxy_connect_timeout 3s;
    proxy_read_timeout    3s;
    access_log off;
  }

  location @backend_down {
    default_type application/json;
    return 503 '{"error":"Backend service unavailable","status":503}';
  }
}
